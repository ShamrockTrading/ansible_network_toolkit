---
# Backup PaloAlto device running configuration (XML API + xmllint)
# Outputs: config_output.backup_path

# 1) Create temp directory
- name: Create a unique temp directory
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

# 2) Request API key using POST + form-urlencoded body (SAFE for special chars)
- name: Request API key (keygen)
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/api/"
    method: POST
    body_format: form-urlencoded
    body:
      type: keygen
      user: "{{ ansible_user }}"
      password: "{{ ansible_password }}"
    return_content: true
    validate_certs: false        # set true once EE trusts root CA
    use_proxy: false
    headers:
      Content-Type: "application/x-www-form-urlencoded"
  register: pan_keygen
  delegate_to: localhost
  no_log: true   # prevent secrets from appearing in job output

- name: Extract API key
  ansible.builtin.set_fact:
    pan_api_key: "{{ (pan_keygen.content | regex_search('<key>([^<]+)</key>', '\\1')) | default('') }}"
  delegate_to: localhost
  no_log: true

- name: Ensure API key obtained
  ansible.builtin.assert:
    that:
      - pan_api_key | length > 0
    fail_msg: "Failed to obtain API key. Enable the temporary debug task above to inspect the XML error message."
  delegate_to: localhost
  no_log: true

# 3) Define XML op command
- name: Build XML op command
  ansible.builtin.set_fact:
    pan_cmd_xml: "<show><config><running></running></config></show>"
  delegate_to: localhost

# 4) Download running config (XML) using POST + form-urlencoded body
- name: Download Palo device running configuration (XML)
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/api/"
    method: POST
    body_format: form-urlencoded
    body:
      type: op
      cmd: "{{ pan_cmd_xml }}"
      key: "{{ pan_api_key }}"
    return_content: true
    validate_certs: false
    use_proxy: false
    headers:
      Content-Type: "application/x-www-form-urlencoded"
  register: pan_run_cfg
  delegate_to: localhost

# 5) Guardrail â€” ensure XML (not JSON)
- name: Ensure response is XML (not JSON)
  ansible.builtin.assert:
    that:
      - pan_run_cfg.content is defined
      - not (pan_run_cfg.content | regex_search('^\\s*\\{'))
    fail_msg: "Palo device returned JSON instead of XML. Check request body fields (type/op/cmd/key)."
  delegate_to: localhost

# 6) Write RAW XML
- name: Write raw XML to file
  ansible.builtin.copy:
    content: "{{ pan_run_cfg.content }}"
    dest: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.raw.xml"
    mode: "0640"
  register: panos_raw_file
  delegate_to: localhost

# 7) Pretty print XML
- name: Pretty print XML via xmllint
  ansible.builtin.command: >
    xmllint --format "{{ panos_raw_file.dest }}"
    -o "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
  delegate_to: localhost

# 8) Optional raw removal
- name: Remove raw XML
  ansible.builtin.file:
    path: "{{ panos_raw_file.dest }}"
    state: absent
  when: not (panos_keep_raw | default(true))
  delegate_to: localhost

# 9) Expose formatted config path
- name: Expose backup path
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
