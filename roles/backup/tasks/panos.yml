---
# Backup Palo Alto Panorama/PAN-OS configuration
# Outputs: config_output.backup_path (for your win_copy step)

- name: Ensure /tmp exists on controller (EE)
  ansible.builtin.file:
    path: /tmp
    state: directory
    mode: "0755"
  delegate_to: localhost
  run_once: true

- name: Export Panorama running configuration (XML) to controller
  paloaltonetworks.panos.panos_export:
    category: "configuration"
    running_config: true
    provider:
      hostname: "{{ ansible_host | default(inventory_hostname) }}"
      api_key: "{{ lookup('env','PANORAMA_API_KEY') | default(omit) }}"
      username: "{{ lookup('env','PANORAMA_USERNAME') | default(omit) }}"
      password: "{{ lookup('env','PANORAMA_PASSWORD') | default(omit) }}"
      timeout: "{{ panos_timeout | default(60) }}"
    to: "/tmp/{{ inventory_hostname }}.xml"
  delegate_to: localhost
  register: panos_export_result

# Make the output path align with your existing play that expects config_output.backup_path
- name: Expose backup path to the caller
  ansible.builtin.set_fact:
    config_output:
      backup_path: "/tmp/{{ inventory_hostname }}.xml"
