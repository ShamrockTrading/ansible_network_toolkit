---
# Backup Panorama running configuration
# Outputs: config_output.backup_path

# 1. Create unique temp directory
- name: Create a unique temp directory for this backup
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

# 2. Retrieve running configuration (forced XML output)
- name: Retrieve running configuration via operational command (XML)
  paloaltonetworks.panos.panos_op:
    provider:
      ip_address: "{{ ansible_host }}"
      username: "{{ ansible_user }}"
      password: "{{ ansible_password }}"
      port: 443
    cmd: "show config running"
    format: "xml"
  delegate_to: localhost
  register: panos_config

# 3. Write raw XML
- name: Write raw XML to file
  ansible.builtin.copy:
    content: "{{ panos_config.stdout }}"
    dest: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.raw.xml"
    mode: "0640"
  delegate_to: localhost
  register: panos_raw_file

# 4. Prettyâ€‘print XML via xmllint
- name: Pretty print XML via xmllint
  ansible.builtin.command: >
    xmllint --format "{{ panos_raw_file.dest }}"
    -o "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
  delegate_to: localhost

# 5. Optionally remove raw file
- name: Remove raw XML
  ansible.builtin.file:
    path: "{{ panos_raw_file.dest }}"
    state: absent
  when: not (panos_keep_raw | default(true) | bool)
  delegate_to: localhost

# 6. Expose formatted backup path
- name: Expose backup path
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
