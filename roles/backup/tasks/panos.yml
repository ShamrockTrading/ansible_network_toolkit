---
# Backup Panorama running configuration via XML API + xmllint
# Outputs: config_output.backup_path  (used by your win_copy step)

# 0) Optional: set this to false if your EE doesn't trust Panorama's cert
# panos_validate_certs: false

# 1) Create unique temp directory for this run
- name: Create a unique temp directory for this backup
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

# 2) Request an API key using your Machine credential (username/password)
#    IMPORTANT: the URL must have NO SPACES
- name: Request Panorama API key (keygen)
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/api/?type=keygen&user={{ ansible_user | urlencode }}&password={{ ansible_password | urlencode }}"
    method: GET
    return_content: true
    validate_certs: false          # disables CA validation
    headers:
      Host: "{{ ansible_host }}"   # suppresses hostname mismatch
    use_proxy: false               # prevents proxy interference
  register: pan_keygen
  delegate_to: localhost

- name: Extract API key from keygen response
  ansible.builtin.set_fact:
    pan_api_key: "{{ (pan_keygen.content | regex_search('<key>([^<]+)</key>', '\\1')) | default('') }}"
  delegate_to: localhost

- name: Ensure API key retrieved
  ansible.builtin.assert:
    that:
      - pan_api_key | length > 0
    fail_msg: "Failed to obtain API key from Panorama. Check username/password and connectivity."
  delegate_to: localhost

# 3) Build the XML op command and fetch the running configuration (always XML)
- name: Define XML op command
  ansible.builtin.set_fact:
    pan_cmd_xml: "<show><config><running></running></config></show>"
  delegate_to: localhost

- name: Download Panorama running configuration (XML)
  ansible.builtin.uri:
    url: "https://{{ ansible_host }}/api/?type=op&cmd={{ pan_cmd_xml | urlencode }}&key={{ pan_api_key | urlencode }}"
    method: GET
    return_content: true
    validate_certs: false
    headers:
      Host: "{{ ansible_host }}"
    use_proxy: false
  register: pan_run_cfg
  delegate_to: localhost

# 4) Guardrail: ensure we received XML (not JSON)
- name: Assert response is XML (not JSON)
  ansible.builtin.assert:
    that:
      - (pan_run_cfg.content | default('')) | length > 0
      - not (pan_run_cfg.content | regex_search('^\\s*\\{'))
    fail_msg: "Panorama returned non-XML content for running config. Check the API URL and parameters."
  delegate_to: localhost

# 5) Write RAW XML
- name: Write raw XML to file
  ansible.builtin.copy:
    content: "{{ pan_run_cfg.content }}"
    dest: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.raw.xml"
    mode: "0640"
  delegate_to: localhost
  register: panos_raw_file

# 6) Prettyâ€‘print XML with xmllint (present in your updated EE)
- name: Pretty print XML via xmllint
  ansible.builtin.command: >
    xmllint --format "{{ panos_raw_file.dest }}"
    -o "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
  delegate_to: localhost

# 7) Optionally remove RAW XML (set panos_keep_raw: false to delete)
- name: Remove raw XML
  ansible.builtin.file:
    path: "{{ panos_raw_file.dest }}"
    state: absent
  when: not (panos_keep_raw | default(true) | bool)
  delegate_to: localhost

# 8) Expose formatted backup path to the caller
- name: Expose backup path
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
