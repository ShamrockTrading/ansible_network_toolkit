---
# Backup Palo Alto Panorama/PAN-OS configuration without relying on panos_export schema.
# Produces: config_output.backup_path (consumed by the win_copy task).

- name: Create a unique temp directory on the controller
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

# Pull the running configuration using the operational command API.
# Requires pan-python/pan-os-python in your EE (which you now have).
- name: Retrieve running configuration via operational command
  paloaltonetworks.panos.panos_op:
    ip_address: "{{ ansible_host | default(inventory_hostname) }}"
    username: "{{ lookup('env','PANORAMA_USERNAME') | default(omit) }}"
    password: "{{ lookup('env','PANORAMA_PASSWORD') | default(omit) }}"
    api_key:  "{{ lookup('env','PANORAMA_API_KEY')  | default(omit) }}"
    cmd: "show config running"
  delegate_to: localhost
  register: panos_config

- name: Write configuration to file
  ansible.builtin.copy:
    content: "{{ panos_config.stdout }}"
    dest: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
    mode: "0640"
  delegate_to: localhost

- name: Expose backup path for downstream win_copy
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
