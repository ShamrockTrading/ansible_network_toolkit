---
# Backup Palo Alto Panorama/PAN-OS configuration
# Outputs: config_output.backup_path (for your win_copy step)

- name: Create a unique temp directory for this backup
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

- name: Export Panorama running configuration (XML) to controller
  paloaltonetworks.panos.panos_export:
    category: "configuration"
    running_config: true
    provider:
      hostname: "{{ ansible_host | default(inventory_hostname) }}"
      api_key: "{{ lookup('env','PANORAMA_API_KEY') | default(omit) }}"
      username: "{{ lookup('env','PANORAMA_USERNAME') | default(omit) }}"
      password: "{{ lookup('env','PANORAMA_PASSWORD') | default(omit) }}"
      timeout: "{{ panos_timeout | default(60) }}"
    to: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
  delegate_to: localhost
  register: panos_export_result

- name: Expose backup path to the caller
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
