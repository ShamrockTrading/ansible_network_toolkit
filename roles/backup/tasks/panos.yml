---
# Backup Panorama running configuration
# Outputs: config_output.backup_path

# 1) Create unique temp directory
- name: Create a unique temp directory for this backup
  ansible.builtin.tempfile:
    state: directory
    prefix: panos_backup_
  register: panos_tmpdir
  delegate_to: localhost

# 2) Retrieve running configuration as XML (supported across module versions)
#    NOTE: We send the XML command and set cmd_is_xml: true
- name: Retrieve running configuration (force XML response)
  paloaltonetworks.panos.panos_op:
    provider:
      ip_address: "{{ ansible_host }}"
      username: "{{ ansible_user }}"
      password: "{{ ansible_password }}"
      port: 443
    cmd: "<show><config><running></running></config></show>"
    cmd_is_xml: true
  delegate_to: localhost
  register: panos_config

# 3) Guardrail: ensure the payload is XML, not JSON
- name: Assert response is XML (not JSON)
  ansible.builtin.assert:
    that:
      - panos_config is defined
      - (panos_config.stdout | default('')) | length > 0
      - not (panos_config.stdout | regex_search('^\\s*\\{'))   # starts with '{' => JSON
    fail_msg: >-
      Panorama returned non-XML content for 'show config running'.
      Ensure cmd_is_xml is true and the XML form of the command is used.
  delegate_to: localhost

# 4) Write RAW XML (keep a pristine copy if you want)
- name: Write raw XML to file
  ansible.builtin.copy:
    content: "{{ panos_config.stdout }}"
    dest: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.raw.xml"
    mode: "0640"
  delegate_to: localhost
  register: panos_raw_file

# 5) Prettyâ€‘print XML via xmllint
- name: Pretty print XML via xmllint
  ansible.builtin.command: >
    xmllint --format "{{ panos_raw_file.dest }}"
    -o "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
  delegate_to: localhost

# 6) Optionally remove the RAW file (toggle with panos_keep_raw=false)
- name: Remove raw XML
  ansible.builtin.file:
    path: "{{ panos_raw_file.dest }}"
    state: absent
  when: not (panos_keep_raw | default(true) | bool)
  delegate_to: localhost

# 7) Expose the formatted file for your Windows copy step
- name: Expose backup path
  ansible.builtin.set_fact:
    config_output:
      backup_path: "{{ panos_tmpdir.path }}/{{ inventory_hostname }}.xml"
